<script src=tailopt.js></script>
<script>

function tailopted (older, newer) {
	outer: while (true) {
		var oldChildren = older.children;
		var newChildren = newer.children;
		var oldLength = older.children.length;
		var newLength = newer.children.length;
		var length = newLength > oldLength ? newLength : oldLength;

		for (var i = 0; i < length; i++) {
			if (i >= newLength) {
				oldChild = oldChildren.pop(); oldLength--; // DOM op: remove node
			} else if (i >= oldLength) {
				oldChildren[i] = newChildren[i]; oldLength++; // DOM op: create node
			} else {
				var newChild = newChildren[i];
				var oldChild = oldChildren[i];

				if (newChild.flag === 1 && oldChild.flag === 1) {
					oldChild.children = newChild.children; // DOM op: update text
				} else if (newChild.type !== oldChild.type) {
					oldChildren[i] = newChild; // DOM op: replace node
				} else {
					// instead of tailopted(oldChild, newChild)
					older = oldChild;
					newer = newChild;
					continue outer;
				}
			}
		}
		break;
	}
}

</script>
