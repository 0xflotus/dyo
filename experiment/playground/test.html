<!doctype html>
<body>
	<div id='app'></div>
	<div id='log'></div>

	<div id="root"></div>
	<!-- <div id=root>
		<h1><input type="text">Hello World 1494293784665 <p>Paragraph</p></h1>
	</div> -->
	<!-- <div id=root>
		<h1>Hello World 1494293784665</h1>
	</div> -->
	<!-- <div id=root><h1>Hello World 1494293784665 <p>Paragraph</p></h1></div> -->
	<div id="portal"></div>
	<script src="../dist/dio.js"></script>

	<script>
		const Component = dio.Component;

		class Message extends Component {
			constructor(props) {
		  	super(props);
		  	this.state = {
		    	active: this.props.active
		    };
		  }

		  componentWillReceiveProps(nextProps) {
		  	if (!this.props.active && nextProps.active) {
		    	this.setState({
		      	active: true
		      });
		    }
		  }

		  componentWillUpdate(nextProps, nextState) {
		  	const logEl = document.querySelector('#log');
		  	const currentStateMessage = document.createElement('p');
		  	const nextStateMessage = document.createElement('p');
		    currentStateMessage.innerHTML = `current active state: ${this.state.active}`;
		    nextStateMessage.innerHTML = `next active state: ${nextState.active}`;
		  	logEl.append(currentStateMessage);
		  	logEl.append(nextStateMessage);

		    if (!this.state.active && nextState.active) {
		      const successMessage = document.createElement('p');
		      successMessage.innerHTML = 'it worked correctly!';
		      logEl.append(successMessage);
		    }
		  }

		  render() {
		  	return h('span', 'Im ', this.state.active ? 'active' : 'inactive', '!');
		  }
		}

		class App extends Component {
			constructor(props) {
		  	super(props);
		    this.state = {
		    	active: false
		    };
		    this.toggleMessage = this.toggleMessage.bind(this);
		  }

		  toggleMessage() {
		  	this.setState({
		    	active: !this.state.active
		    });
		  }

		  render() {
		  	return h('div',
		  		h('button', {onClick: this.toggleMessage}, 'Toggle active state'),
		  		h(Message, {active: this.state.active})
	  		)
		  }
		}

		dio.render(App, document.getElementById('app'));

		var el = h('style', `
				* {color:red}
		`)

		// <!-- [if lte IE 9]>
	  	// <script src="/public/media.match.js">
		// <![endif]-->

		// dio.render(h('!', 'comment'), document.body)

		var time = 0;

		class Error {
			render () {
				if (time++ === 1) throw ''
					return 'works'
			}
		}

		dio.render(Error)
		dio.render(Error)

		// dio.render(h('div'), req, () => {})

		class Styled {
			static stylesheet () {
				return `
					& {
						color: red;
						display: block;
					}

					h1 {
						color: red;
					}
				`;
			}
			render() {

			}
		}

var sample = `
color: red;
display: block;

&, :global(h1 &) {
	color: red;
	display: block;
	transform: none;
}

width: 100px;

h1, h2:not(h2, h3),
[title='something, else'],
:hover {
	color: red;
}

@media () {
	h1, h2, & {
		color: 	red;
	}
}

@keyframes animation {
	0%: {
		color: red;
	}
}
		`

var rsels = /^[^@}\s][^};]*?\{$/gm
var rsel = /,[\s]*(?![^\(\[]*[\)\]])/g
var rprop = /^.*;$/gm;
var rwhite = /^[\s]+/gm;
var rminify = /[\r\n\t]+/g;
var rflat = /[^}{\s]*:[^}{]*;(?![^{]*\})/g
var rnest = /([^{;]*)\{([\s\S]*?})\s*}(?![\s]*\})/gm;
var namespace = '#prefix';
var webkit = '-webkit-';
var moz = '-moz-';
var ms = '-ms-';

function selectors (match) {
	var items = match.substring(0, match.length-2).trim().split(rsel);
	var i = items.length;
	while (i-- > 0) {
		var item = items[i];
		var length = item.length;

		if (item.charCodeAt(length-1) !== 58) {
			switch (item.charCodeAt(0)) {
				case 38: item = namespace; break;
				case 58: {
					switch (item.charCodeAt(1)) {
						case 103: item = item.substring(8, length-1).replace(/&/g, namespace); break;
						default: item = namespace + item; break;
					}
				}
				default: item = namespace + ' ' + item;
			}
			items[i] = item;
		}
	}
	return items.join(',') + '{';
}

function properties (match) {
	var split = match.indexOf(':');
	var name = match.substring(0, split).trim();
	var value = match.substring(split+1, match.length-1).trim();

	switch (name) {
		case 'transform': {
			return prefix(name, value, true, true, true);
		}
		default: return name + ':' + value + ';';
	}

	return prefix(name, value);
}

function prefix (name, value, wk, mz, ie) {
	var set = '';
	if (moz) set += webkit + name + ':' + value + ';';
	if (mz) set += moz + name + ':' + value + ';';
	if (ie) set += ms + name + ':' + value + ';';
	return set + name + ':' + value + ';';
}

function process (ns, css) {
	namespace = ns;
	return css
		.replace(rwhite, '')
		.replace(rsels, selectors)
		.replace(rprop, properties)
		.replace(rflat, flat)
		.replace(rminify, '')
		// .replace(rnest, nest)
}

function flat (match) {
	return namespace+'{'+match.replace(/[\r\n\t]/g, '')+'}';
}

function nest (match, selector, body) {
	var out = body.replace(rnest, nest);
	if (out !== match) {
		return out;
	}
	return match;
	// return process();
}

// console.log(`h1 {
// color: blue;
// h2 {
// 	color: red;
// 	h3 {
// 		color: orange;
// 	}
// }
// }`.replace(/[\r\n\t]+/g, '').replace(rnest, nest))

// console.log(
// 	process('#id', `h1 {
// 	color: blue;
// 	h2 {
// 		color: red;
// 		h3 {
// 			color: orange;
// 		}
// 	}
// 	}`)
// );

console.log(process('#prefix', sample));
	</script>

	<script>
		const root = document.getElementById('root');
		const node = document.getElementById('portal');
		const h1 = root.querySelector('h1');

		class foo {
			render () {
				return bar
			}
		}

		class bar {
			render() {
				return h('h1', h('input', {value: 'chanegd', oninput: () =>{
					console.log('works');
				}}), 'Hello World - ', Date.now(),
					h('p', 'Paragraph')
					// h(node, 1, 2)
				)
			}
		}

		// dio.render(foo, root, h1);

		// dio.render({id: 1}, root);

		const animation = {
			fadeOut: [
			  {transform: 'translateY(0)', opacity: 1},
		  	{transform: 'translateY(-100%)', opacity: 0}
		  ],
		  fadeIn: [
	  	  {transform: 'translateY(-100%)', opacity: 0},
	    	{transform: 'translateY(0%)', opacity: 1}
		  ]
		};

		function fadeIn (el) {
			return el.animate(animation.fadeIn, {delay: 200, duration: 200, fill: 'backwards'});
		}

		function fadeOut (el) {
			return el.animate(animation.fadeOut, {duration: 200});
		}

		class Input {
			componentDidThrow () {
				console.log('didThrow');
				return h('h1', 'Error state');
			}
			componentDidMount(el) {
				fadeIn(el);
			}
			componentWillUnmount(el) {
				return new Promise((r) => fadeOut(el).onfinish = r)
			}
			handleInput(props, state, event) {
				const {target} = event
				const {value} = target
				return {value}
			}
			render() {
				return h('div',
					h('input', {
						type: 'text',
						oninput: this.handleInput
					}),
					h('h1', this.state.value)
				)
			}
		}

		class Input2 {
			handleInput(props, state, event) {
				const {target} = event
				const {value} = target
				return {value}
			}
			componentDidMount(el) {
				fadeIn(el)
			}
			render() {
				return h('div',
					h('input', {
						type: 'text',
						oninput: this.handleInput,
						defaultValue: 'something'
					}),
					h('h1', this.state.value)
				)
			}
		}

		class Apps {
			render () {
				return this.props.children
			}
		}

		// dio.render(h(App, Input, Input, Input), root);

		// setTimeout(dio.render, 1000, h(App, Input, Input, Input, Input), root);
		// setTimeout(dio.render, 2000, h(App, Input, Input, Input), root);

		class A {
		  componentWillUnmount() {console.log('unmount - A')}
		  render() {return B}
		}

		class B {
		  componentWillUnmount() {console.log('unmount - B')}
		  render() {return C}
		}

		class C {
		  componentWillUnmount() {console.log('unmount - C')}
		  render() {return 'C'}
		}

		// dio.render(A, document.getElementById('app'))
		// dio.render('Replace', document.getElementById('app'))

		// dio.render(h('button', {onclick: (e)=>console.log(e)}, 'Click Me'))

		const animations = {
			fadeOut: [
			  {transform: 'translateY(0)', opacity: 1},
		  	{transform: 'translateY(-100%)', opacity: 0}
		  ],
		  fadeIn: [
			  {transform: 'translateY(-100%)', opacity: 0},
		  	{transform: ' translateY(0%)', opacity: 1}
		  ]
		}

		class Item {
			componentDidMount(el) {
				el.animate(animations.fadeIn, {
					duration: 200
				});
			}
			componentWillUnmount(el) {
				return new Promise((resolve) => {
					el.animate(animations.fadeOut, {
						duration: 200
					}).onfinish = resolve
				})
			}
			render() {
				return h('li', {
					ref: ref
				}, this.props.children)
			}
		}

		const ref = (a) => {
			console.log(a);
		}

		class List {
			render() {
				return [
					h('svg', {width: 500, height: 40, viewBox: '0 0 500 40'},
						h('text', {x: 0, y: 35, 'font-family': 'Verdana', 'font-size': 35}, 'Hello, out there')
					),
					h(`svg`,
	       		[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(id => (
		         	h(`g`, {
			           'key': id,
		         	},
	           		h(`circle`, {
	           			'cx': 5 + 10 * id,
	           			'cy': 5,
	           			'r': 5,
		           	})
		         	)
		       	))
		     	),
					h('br'),
					X,
					foos,
					h('ul', this.props.children.map(
						v => h(Item, v)
					))
				]
			}
		}

		// dio.render(h(List, 1, 2, 3), root)

		var state = 0;

		class X {
			componentWillUnmount() {
				console.log('willUnmount - ', this.constructor.name);
			}
			componentWillMount() {
				console.log('willMount - ', this.constructor.name);
			}
			componentDidUpdate() {
				console.log('didUpdate - ', this.constructor.name);
			}
			render () {
				return [
					100,
					{id: 1, name: 'Hello', nest: {age: 20}}
				]
				return Y;
			}
		}

		class Y {
			componentWillUnmount() {
				console.log(this.this);
				console.log('willUnmount - ', this.constructor.name);
			}
			componentWillMount() {
				console.log('willMount - ', this.constructor.name);
			}
			componentDidUpdate() {
				console.log('didUpdate - ', this.constructor.name);
			}
			render () {
				return state > 1 ? E : Z;
			}
		}

		class Z {
			componentWillUnmount() {
				console.log(this.this);
				console.log('willUnmount - ', this.constructor.name);
			}
			componentWillMount() {
				console.log('willMount - ', this.constructor.name);
			}
			componentDidUpdate() {
				console.log('didUpdate - ', this.constructor.name);
			}
			render() {
				return h('h1', 'I Am Z - ', state++)
			}
		}

		class E {
			componentWillUnmount() {
				console.log('willUnmount - ', this.constructor.name);
			}
			componentWillMount() {
				console.log('willMount - ', this.constructor.name);
			}
			componentDidUpdate() {
				console.log('didUpdate - ', this.constructor.name);
			}
			render () {
				return h('h2', 'I Am E - ', Date.now());
			}
		}

		// dio.render(X, root);

		function event (e) {
			console.log(this, e)
		}

		function foos () {
			return h('button', {onclick: event}, 'Click Me - ', performance.now());
		}

		// dio.render(X, root);

		// setTimeout(()=>dio.render(X, root), 1000)
		// setTimeout(()=>dio.render(X, root), 2000)
		// setTimeout(()=>dio.render(null, root), 3000)

		class Lists {
			render() {
				console.log(this.props);

				return h('ul', this.props.children.map(
					v => h(Item, {key: v}, v)
				))
			}
		}

		// dio.render(h(Lists, 1, 2, 3), root, 'destroy');

		// setTimeout(dio.render, 1000, h(Lists, 1, 2), root)
		// setTimeout(dio.render, 2000, h(Lists, 1, 2, 3, 4), root)
		// setTimeout(dio.render, 2000, h(Lists), root)
		// setTimeout(dio.render, 4000, h(Lists, 1, 2, 3, 4), root)


		class Foo {
			componentWillMount() {
				console.log(true, 'componentWillMount');
			}
			componentDidMount() {
				console.log(true, 'componentDidMount');
			}
			componentWillUpdate() {
				console.log(true, 'componentWillUpdate');
			}
			componentDidUpdate() {
				console.log(true, 'componentDidUpdate');
			}
			componentWillReceiveProps() {
				console.log(true, 'componentWillReceiveProps');
			}
			componentWillUnmount() {
				console.log(true, 'componentWillUnmount');
			}
			shouldComponentUpdate() {
				console.log(true, 'shouldComponentUpdate');
			}
			render() {
				return h(Bar, this.props);
			}
		}

		class Bar {
			componentWillUpdate() {
				console.log(true, 'componentWillUpdate - composite');
			}
			componentDidUpdate() {
				console.log(true, 'componentDidUpdate - composite');
			}
			render() {
				return h('h1', this.props.id);
			}
		}

		// dio.render(h(Foo, {id: 1}));
		// dio.render(null);

		// replace
		// remove
		// preserve [default]
	</script>
</body>
</html>
