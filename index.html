<style>
	:root {
		--color-page-text: #333;
		--color-page-bg: #fff;
		--color-button-bg: #f7f7f7;
		--color-button-border: #e7e7e7;
		--pt: 0.5em;
	}

	* {
		box-sizing: border-box;
	}

	html {
		margin: 0;
		padding: calc(var(--pt)*4);
		font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
		color: var(--color-page-text);
		background-color: var(--color-page-bg);
	}

	ul {
		display: grid;
		gap: 0.5em 0.5em;
		grid-template-columns: repeat(auto-fill, 20em);
		padding: 0px;
		margin: 0px;
	}

	li {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 1em;
		background-color: var(--color-button-bg);
		border: 1px solid var(--color-button-border);
		border-radius: 1em;
		cursor: pointer;
	}

	small {
		display: block;
		font-size: 1em;
		margin-top: 0.5em;
	}

	.arrow {
		width: 24;
		height: 24;
	}

	.spinner {
		width: 30;
		height: 30;
		stroke-dasharray: 100;
		stroke-dashoffset: 0;
		-webkit-transform-origin: center;
		transform-origin: center;
		animation: dash-keyframe 1.3s ease-in-out infinite;
	}

	.spinner circle {
		fill: none;
		stroke: currentColor;
		stroke-width: 4;
		stroke-linecap: round;
		cx: 15;
		cy: 15;
		r: 11px;
	}

	@keyframes dash-keyframe {
		0% { stroke-dashoffset: 100; }
		50% { stroke-dashoffset: 50; transform: rotate(135deg); }
		100% { stroke-dashoffset: 100; transform: rotate(450deg); }
	}
	@keyframes rotate-keyframe {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(270deg); }
	}

main {
	display: grid;
	grid-template-columns: 200px 200px;
}
</style>

<header id=c><h1>16,000 nodes</h1></header>
<main>
	<section id="a"></section>
	<section id="b"></section>
</main>

<script>
	window.process = {env: {NODE_ENV: 'development'}}
</script>

<script type=module>
	import {h, render, Component, Fragment, createPortal, createComment} from './index.js'

	;(() => {
		render(createPortal('Hello World', 'section', {class: 'foo'}), 'main')
		render(createPortal('World Hello', 'article', {class: 'bar'}), 'main')
		// render(null, 'main')
	});

	;(() => {
		class Primary extends Component {}

		const A = new Promise((r) => r('1'))
		const B = new Promise((r) => {
			setTimeout(r, 3000, '2')
			// r('2')
		})

		render(h('div', h(A, {timeout: 0}, 'Loading')), 'main', (current) => {
			console.log(current.innerHTML)
		})

		console.log('-----')

		render(h('div', h(B, {timeout: 1200}, 'Loading')), 'main', (current) => {
			console.log(current.innerHTML)
		})
	});
</script>

<script type='module'>
	import {h, render, Component} from './index.js'

	// class Primary extends Component {
	// 	componentDidMount() {
	// 		// console.log('Primary - Mount', ...arguments)
	// 	}
	// 	componentDidUpdate() {
	// 		// console.log('Primary - Update', ...arguments)
	// 	}
	// }

	// class Secondary extends Component {
	// 	static propTypes(props) {
	// 		return {
	// 			value: (props, key, display, type) => {
	// 				console.log(props, key,  display, type)
	// 				return type
	// 			}
	// 		}
	// 	}
	// 	constructor(...args) {
	// 		super(...args)
	// 		this.state = {value: 2}
	// 	}
	// 	componentDidMount() {
	// 		// console.log('Secondary - Mount', ...arguments)
	// 	}
	// 	componentDidUpdate() {
	// 		// console.log('Secondary - Update', ...arguments)
	// 	}
	// 	handleEvent() {
	// 		return {value: 3}
	// 	}
	// 	render({children}) {
	// 		return h('div',
	// 			h('button', {onClick: this}, 'Select'),
	// 			h('h1', {class: 'heading', style: {color: 'red', 'fontSize': '80px'}}, 'Hello'),
	// 			h('select', {value: this.state.value},
	// 				h('option', {value: 1}, 1),
	// 				h('option', {value: 2}, 2),
	// 				h('option', {value: 3}, 3)
	// 			),
	// 			children
	// 		)
	// 	}
	// }

	// render(h(Primary, {}, h(Secondary, h(Promise.resolve('World'), 'Loading...'))), 'main', (e) => {
	// 	console.log('mount', e)
	// })

	// render(h(Primary, h(Secondary, h(Promise.resolve('Hello'), 'Loading...'))), 'main', (e) => {
	// 	console.log('update', e)
	// })

	// render(h(Primary, h('h1', 'Hello World')), 'main')




	// const assert = {deepEqual() {}}

	// const target = 'main'
	// const stack = []

	// class Primary extends Component {
	// 	componentDidCatch(error) { stack.push.apply(stack, error) }
	// }

	// class Secondary extends Component {
	// 	render({children}) { return h(Tertiary, children) }
	// }

	// class Tertiary extends Component {
	// 	static propTypes() {
	// 		return {
	// 			children(props, name, display, type) {
	// 				if (typeof props[name] !== 'number') {
	// 					return [props, name, display, type]
	// 				}
	// 			}
	// 		}
	// 	}
	// }

	// render(h(Primary, h(Secondary, 'prop')), target, (current) => {
	// 	assert.deepEqual(stack, [''])
	// })

	// console.log(stack)
;(() => {
  var a = document.querySelector('#a')
  var b = document.querySelector('#b')
  var c = document.querySelector('#c')

  function append (parent) {
    parent.textContent = ''
    for (var i = 0; i < 1000; i++) {
      var div = document.createElement('div')
      var txt = div.appendChild(document.createTextNode(`Hello ${i}`))
      parent.appendChild(div)
    }
  }

  // 1 ops because hydration is never a "hot" operation
  // since it happens at most once per page load
  // both varients share a similar cb function
  // that sets up the stage, simulating an initial server rendered stage.
  function bench (name, cb, fn, ops = 1) {
    var start = performance.now()
    for (var i = 0; i < ops; i++) {
      cb()
      fn()
    }
    var end = performance.now()
    var res = `<h4>${name}: ${(((end-start)/ops) | 0)} ms/ops</h4>`
    c.innerHTML += res
    console.log(res)
  }

  // simulates the minimum amount of work hydration needs to atleast do.
  bench('hydrate', () => append(a), () => {
    var treeWalker = document.createTreeWalker(a)
    while(treeWalker.nextNode()) {
      var current = treeWalker.currentNode
      if (current.nodeName.toLowerCase() === '#text') {
        if (current.nodeValue === '#') {
          throw '!'
        }
      }
    }
  })

  bench('create', () => append(b), () => {
    append(b)
  })
})()
</script>

<script type=!module>
	import {h, render, Component, Fragment, Children} from './index.js'

	const data = {
		entries: [
			{
				name: 'Andrew Clark',
				username: 'acdlite'
			}
		]
	}

	class Placeholder {
		componentDidCatch(error, info) {
			if (typeof Object(error).then === 'function') {
				var resolved = false

				setTimeout(() => {
					if (!resolved) {
						this.setState({children: h(LoadingSpinner, {hidden: false})})
					}
				}, 3100)

				error.then(() => {
					resolved = true
					this.setState({children: this.props.fallback})
				})
			} else {
				this.setState({children: h('h1', 'Failed!!')})
			}
		}
		render(props, state) {
			return state.children || props.children
		}
	}

	class LoadingSpinner {
		render({hidden}) {
			return h('div', {class: 'spinner-container', hidden: hidden},
				h('svg', {class: "spinner", viewBox: "0 0 30 30"}, h('circle'))
			)
		}
	}

	class ArrorIcon {
		render({hidden}) {
			return h('div', {class: 'arrow-container', hidden: hidden},
				h('svg', {class: 'arrow', viewBox: '0 0 24 24'},
					h('path', {fill: 'none', d: 'M0 0h24v24H0z'}),
					h('path', {d: 'M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'})
				)
			)
		}
	}

	var ref = (a) => console.log('ref', a)

	class ListItem {
		handleEvent() {
			return () => {
				return {loading: !this.state.loading}
			}
		}
		componentWillUnmount() {
			console.log('componentWillUnmount - ListItem')
		}
		componentDidUpdate(props, state) {
			console.log('componentDidUpdate - ListItem')
			// throw 1
			throw new Promise((resolve) => setTimeout(resolve, 3000))
			return () => {
				// throw Promise.resolve()
				throw new Promise((resolve) => setTimeout(resolve, 3000))
			}
		}
		render ({name, username}, {loading}) {
			return h('li', {ref: ref, onClick: this.handleEvent},
				h('div', h('strong', name), h('small', username)),
				h(ArrorIcon, {hidden: loading}),
				h(LoadingSpinner, {hidden: !loading})
			)
		}
	}

	class Application {
		render({children}) {
			return h(Placeholder, {fallback: h('h1', 'Success!!')},
				h('h1', 'React Core Team'),
				h('ul', Children.map(children, (props) => {
					return h(ListItem, props)
				}))
			)
		}
	}

	render(h(Application, data.entries), 'section')
</script>
