<style>
	:root {
		--color-page-text: #333;
		--color-page-bg: #fff;
		--color-button-bg: #f7f7f7;
		--color-button-border: #e7e7e7;
		--pt: 0.5em;
	}

	* {
		box-sizing: border-box;
	}

	html {
		margin: 0;
		padding: calc(var(--pt)*4);
		font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
		color: var(--color-page-text);
		background-color: var(--color-page-bg);
	}

	ul {
		display: grid;
		gap: 0.5em 0.5em;
		grid-template-columns: repeat(auto-fill, 20em);
		padding: 0px;
		margin: 0px;
	}

	li {
		display: flex;
		align-items: center;
		justify-content: space-between;
		padding: 1em;
		background-color: var(--color-button-bg);
		border: 1px solid var(--color-button-border);
		border-radius: 1em;
		cursor: pointer;
	}

	small {
		display: block;
		font-size: 1em;
		margin-top: 0.5em;
	}

	.arrow {
		width: 24;
		height: 24;
	}

	.spinner {
		width: 30;
		height: 30;
		stroke-dasharray: 100;
		stroke-dashoffset: 0;
		-webkit-transform-origin: center;
		transform-origin: center;
		animation: dash-keyframe 1.3s ease-in-out infinite;
	}

	.spinner circle {
		fill: none;
		stroke: currentColor;
		stroke-width: 4;
		stroke-linecap: round;
		cx: 15;
		cy: 15;
		r: 11px;
	}

	@keyframes dash-keyframe {
		0% { stroke-dashoffset: 100; }
		50% { stroke-dashoffset: 50; transform: rotate(135deg); }
		100% { stroke-dashoffset: 100; transform: rotate(450deg); }
	}

	@keyframes rotate-keyframe {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(270deg); }
	}
</style>
<main></main>
<script src='./dist/dyo.umd.js'></script>
<script type=module>
	import * as dyo from './index.js'
	// import * as dyo from './dist/dyo.esm.js'

	const {h, render, Component} = dyo

	;(() => {
		var description = {
			querySelector: that,
			createElement: that,
			createElementNS: that,
			createComment: that,
			createTextNode: that,
			createDocumentFragment: that,
			insertBefore: that,
			appendChild: that,
			removeChild: that,
			addEventListener: noop,
			setAttribute: noop,
			removeAttribute: noop,
			style: {setProperty: noop}
		}

		var owner = new (Object.defineProperty(function owner () {
			this.nodeType = NaN
			this.nodeValue = null
			this.textContent = null
			this.documentElement = this
			this.ownerDocument = this
		}, 'prototype', {value: description}))

		function noop () {}

		function that () { return this }

		function kebab (str) {
			return str.replace(/([A-Z])/, '-$1').toLowerCase()
		}

		function serialize (element) {
			var type = element.type
			var children = element.children

			if (typeof children !== 'object') {
				return type !== '#comment' ? children : '<!--' + children + '-->'
			}

			switch (typeof type) {
				case 'string':
					var props = properties(element.props, children)

					switch (type) {
						case 'area': case 'base': case 'br': case 'meta': case 'source': case 'keygen':
						case 'img': case 'col': case 'embed': case 'wbr': case 'track': case 'param':
						case 'link': case 'input': case 'hr': case '!doctype':
							return '<' + type + props + '>'
					}

					return '<' + type + props + '>' + children.map(serialize).join('') + '</' + type + '>'
			}

			return children.map(serialize).join('')
		}

		function properties (props, children) {
			var payload = ''

			for (var key in props) {
				payload += property(key, props[key], props, children)
			}

			return payload
		}

		function property (name, value, props, children) {
			switch (name) {
				case 'innerHTML':
					children.splice(0, children.length, h([], value))
				case 'ref': case 'key':
					return ''
				case 'style':
					if (typeof value !== 'string') {
						value = style(value)
					}
			}

			switch (value) {
				case false: case null: case undefined:
					return ''
				case true:
					value = name
			}

			switch (typeof value) {
				case 'object': case 'function':
					return ''
			}

			return ' ' + name + '="' + value + '"'
		}

		function style (value) {
			var payload = ''

			for (var key in value) {
				payload += kebab(key) + ':' + value[key] + ';'
			}

			return payload
		}

		function header (value) {
			if (typeof value === 'object') {
				value['context-type'] = value['context-type'] || 'text/html'
			}
		}

		function flush (value) {
			if (typeof value.end === 'function') {
				if (!value.finished) {
					value.end()
				}
			}
		}

		function write (value) {
			value.write(serialize(this))
		}

		function adopt (value) {
			value.ownerDocument = owner, value.appendChild = value.removeChild = value.insertBefore = noop
		}

		function render(element, target, callback) {
			if (target) {
				if (typeof target.write === 'function') {
					if (!target.ownerDocument) {
						adopt(target.constructor.prototype)
					}

					try {
						header(target.headers)
					} finally {
						return dyo.render(element, target, write).then(callback).then(flush)
					}
				}
			}

			return dyo.render(element, target, callback)
		}

		class Response {
			get headers() { return this }
			write(value) {
				console.log(value)
			}
		}


		const node = h('div',
			h('img', {key: 1, ref: () => {}, onClick: () => {}, onLoad: {}, src: 'url'}),
			h('h1', {
				checked: true, disabled: false, class: 'title', style: {marginTop: '20px'},
				tabIndex: 1, value: 'Hello', innerHTML: 'Inner HTML'
			}),
			'Hello', [' ', 'World']
		)

		const value = render(node, new Response, (current) => {
			return console.log(1)
		})

		value.then((value) => {
			console.log(2)
		})
	})();
</script>
<script type=!module>
	import {h, render, Component, Fragment, Children} from './index.js'

	const data = {
		entries: [
			{
				name: 'Andrew Clark',
				username: 'acdlite'
			}
		]
	}

	class Placeholder {
		componentDidCatch(error, info) {
			if (typeof Object(error).then === 'function') {
				var resolved = false

				setTimeout(() => !resolved && this.setState({children: h(LoadingSpinner, {hidden: false})}), 3100)

				return error.then(() => (resolved = true, this.setState({children: this.props.fallback})))
			} else {
				this.setState({children: h('h1', 'Failed!!')})
			}
		}
		render(props, state) {
			return state.children || props.children
		}
	}

	class LoadingSpinner {
		render({hidden}) {
			return h('div', {class: 'spinner-container', hidden: hidden},
				h('svg', {class: "spinner", viewBox: "0 0 30 30"}, h('circle'))
			)
		}
	}

	class ArrorIcon {
		render({hidden}) {
			return h('div', {class: 'arrow-container', hidden: hidden},
				h('svg', {class: 'arrow', viewBox: '0 0 24 24'},
					h('path', {fill: 'none', d: 'M0 0h24v24H0z'}),
					h('path', {d: 'M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z'})
				)
			)
		}
	}

	class ListItem {
		handleEvent() {
			this.setState({loading: !this.state.loading}, () => {
				console.log('done!')
			})
		}
		componentWillUnmount() {
			console.log('componentWillUnmount - ListItem')
		}
		componentDidUpdate(props, state) {
			console.log('componentDidUpdate - ListItem')
			throw new Promise((resolve) => setTimeout(resolve, 3000))
		}
		render ({name, username}, {loading}) {
			return h('li', {onClick: this.handleEvent},
				h('div', h('strong', name), h('small', username)),
				h(ArrorIcon, {hidden: loading}),
				h(LoadingSpinner, {hidden: !loading})
			)
		}
	}

	class Application {
		render({children}) {
			return h(Placeholder, {fallback: h('h1', 'Success!!')},
				h('h1', 'React Core Team'),
				h('ul', Children.map(children, (props) => {
					return h(ListItem, props)
				}))
			)
		}
	}

	render(h(Application, data.entries), 'main')
</script>
